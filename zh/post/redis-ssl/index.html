<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Redis 的 SSL - Qing&#39;s Landing</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Guoqing Geng" /><meta name="description" content="这篇博客的起源是一位内部用户询问，Azure Cache for Redis 有没有 .pem 或者 .cem 的证书，然后可以在客户端指定它：
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  import redis try: conn = redis.StrictRedis( host=&amp;#39;&amp;lt;cache-name&amp;gt;.redis.cache.windows.net&amp;#39;, port=6380, password=&amp;#39;your password here&amp;#39;, ssl=True, ssl_ca_certs=&amp;#39;path to cert&amp;#39;) print (conn) conn.ping() print (&amp;#39;Connected!&amp;#39;) except Exception as ex: print (&amp;#39;Error:&amp;#39;, ex) exit(&amp;#39;Failed to connect, terminating.&amp;#39;)  " /><meta name="keywords" content="Redis, SSL" />






<meta name="generator" content="Hugo 0.54.0 with even 4.0.0" />


<link rel="canonical" href="https://hellokangning.github.io/zh/post/redis-ssl/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Redis 的 SSL" />
<meta property="og:description" content="这篇博客的起源是一位内部用户询问，Azure Cache for Redis 有没有 .pem 或者 .cem 的证书，然后可以在客户端指定它：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15


import redis

try:
    conn = redis.StrictRedis(
        host=&#39;&lt;cache-name&gt;.redis.cache.windows.net&#39;,
        port=6380,
        password=&#39;your password here&#39;,
        ssl=True,
        ssl_ca_certs=&#39;path to cert&#39;)
    print (conn)
    conn.ping()
    print (&#39;Connected!&#39;)
except Exception as ex:
    print (&#39;Error:&#39;, ex)
    exit(&#39;Failed to connect, terminating.&#39;)

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hellokangning.github.io/zh/post/redis-ssl/" />
<meta property="article:published_time" content="2018-12-26T10:26:19&#43;08:00"/>
<meta property="article:modified_time" content="2018-12-26T10:26:19&#43;08:00"/>

<meta itemprop="name" content="Redis 的 SSL">
<meta itemprop="description" content="这篇博客的起源是一位内部用户询问，Azure Cache for Redis 有没有 .pem 或者 .cem 的证书，然后可以在客户端指定它：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15


import redis

try:
    conn = redis.StrictRedis(
        host=&#39;&lt;cache-name&gt;.redis.cache.windows.net&#39;,
        port=6380,
        password=&#39;your password here&#39;,
        ssl=True,
        ssl_ca_certs=&#39;path to cert&#39;)
    print (conn)
    conn.ping()
    print (&#39;Connected!&#39;)
except Exception as ex:
    print (&#39;Error:&#39;, ex)
    exit(&#39;Failed to connect, terminating.&#39;)

">


<meta itemprop="datePublished" content="2018-12-26T10:26:19&#43;08:00" />
<meta itemprop="dateModified" content="2018-12-26T10:26:19&#43;08:00" />
<meta itemprop="wordCount" content="1397">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Redis 的 SSL"/>
<meta name="twitter:description" content="这篇博客的起源是一位内部用户询问，Azure Cache for Redis 有没有 .pem 或者 .cem 的证书，然后可以在客户端指定它：


 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15


import redis

try:
    conn = redis.StrictRedis(
        host=&#39;&lt;cache-name&gt;.redis.cache.windows.net&#39;,
        port=6380,
        password=&#39;your password here&#39;,
        ssl=True,
        ssl_ca_certs=&#39;path to cert&#39;)
    print (conn)
    conn.ping()
    print (&#39;Connected!&#39;)
except Exception as ex:
    print (&#39;Error:&#39;, ex)
    exit(&#39;Failed to connect, terminating.&#39;)

"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/zh/" class="logo">Qing&#39;s Landing</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/zh/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/zh/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/zh/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/zh/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/en/">
        <li class="mobile-menu-item">EN</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/zh/" class="logo">Qing&#39;s Landing</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/zh/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/zh/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/zh/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/zh/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/en/">EN</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Redis 的 SSL</h1>

      <div class="post-meta">
        <span class="post-time"> Dec 26, 2018 </span>
        <div class="post-category">
            <a href="/zh/categories/redis/"> Redis </a>
            </div>
          <span class="more-meta"> 约 1397 字 </span>
          <span class="more-meta"> 预计阅读 3 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#ssl-的单向认证和双向认证">SSL 的单向认证和双向认证</a></li>
<li><a href="#redis-py-源码">redis-py 源码</a></li>
<li><a href="#python-ssl">Python SSL</a></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>这篇博客的起源是一位内部用户询问，Azure Cache for Redis 有没有 <em>.pem</em> 或者 <em>.cem</em> 的证书，然后可以在客户端指定它：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">redis</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span>
        <span class="n">host</span><span class="o">=</span><span class="s1">&#39;&lt;cache-name&gt;.redis.cache.windows.net&#39;</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="mi">6380</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="s1">&#39;your password here&#39;</span><span class="p">,</span>
        <span class="n">ssl</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">ssl_ca_certs</span><span class="o">=</span><span class="s1">&#39;path to cert&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">ping</span><span class="p">()</span>
    <span class="k">print</span> <span class="p">(</span><span class="s1">&#39;Connected!&#39;</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="k">print</span> <span class="p">(</span><span class="s1">&#39;Error:&#39;</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
    <span class="nb">exit</span><span class="p">(</span><span class="s1">&#39;Failed to connect, terminating.&#39;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>在 Azure 的<a href="https://docs.microsoft.com/en-us/azure/azure-cache-for-redis/cache-faq">官方文档</a>上，有这么一句：</p>

<blockquote>
<p>Redis server does not natively support SSL, but Azure Cache for Redis does. If you are connecting to Azure Cache for Redis and your client supports SSL, like StackExchange.Redis, then you should use SSL.</p>
</blockquote>

<p>Redis 并不支持 SSL，但 Azure Cache for Redis 可以。</p>

<p>关于 SSL 在 Redis 上的始先，争论由来已久。这个 issue <a href="https://github.com/antirez/redis/issues/2178">Redis SSL support</a>，最后无疾而终。官网的 <a href="https://redis.io/topics/encryption">Redis Encryption</a> 也是建议引入一个中间层来解决 SSL 的问题。我相信 Azure Cache 也是这么干的。</p>

<h1 id="ssl-的单向认证和双向认证">SSL 的单向认证和双向认证</h1>

<p>所以，才有这篇文档 <a href="https://docs.microsoft.com/en-us/azure/azure-cache-for-redis/cache-python-get-started">Quickstart: Use Azure Cache for Redis with Python</a> 中的 <code>ssl = True</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">redis</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;&lt;Your Host Name&gt;.redis.cache.windows.net&#39;</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="mi">6380</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;&lt;Your Access Key&gt;&#39;</span><span class="p">,</span> <span class="n">ssl</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="nb">set</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">)</span> <span class="c1"># True</span>
<span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span> <span class="c1">#b&#39;bar&#39;</span></code></pre></td></tr></table>
</div>
</div>
<p>既然 <code>ssl = True</code> 已经开启了 SSL，那 <code>ssl_ca_certs</code> 这个参数是做什么的呢？</p>

<p>这就要说到 SSL 协议的加密过程了。SSL协议即用到了对称加密也用到了非对称加密(公钥加密)，在建立传输链路时，SSL首先对对称加密的密钥使用公钥进行非对称加密，链路建立好之后，SSL对传输内容使用对称加密。</p>

<p>下图来自 <a href="https://blog.csdn.net/chenchuanhai04/article/details/77185855">SSL单向认证和双向认证交互流程</a>。</p>

<p>没有设置 <code>ssl_ca_certs</code> 参数的时候，采用的是 SSL 单向认证，即客户端会验证服务器的身份，服务器不会验证客户端。这种情况下，客户端也就不用提交自己的证书，任何用户都可以访问服务器。</p>

<p><img src="/images/ssl-one-way.png" alt="" /></p>

<p>设置 <code>ssl_ca_certs</code> 的情况下，采用 SSL 双向认证。服务端和客户都拿都需要身份证明，服务端只能由允许的客户访问，安全性也会高一些。</p>

<p><img src="/images/ssl-two-way.png" alt="" /></p>

<blockquote>
<p>Take is cheap. Show me the code.</p>
</blockquote>

<h1 id="redis-py-源码">redis-py 源码</h1>

<p>如果设置了 <code>ssl</code> 参数，客户端就会新建一个 <code>SSLConnection</code> 连接，否则就是一个 <code>UNIXDomainSocketConnection</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">Redis</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">,</span>
                 <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">socket_timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">socket_connect_timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">socket_keepalive</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">socket_keepalive_options</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">connection_pool</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">unix_socket_path</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">encoding_errors</span><span class="o">=</span><span class="s1">&#39;strict&#39;</span><span class="p">,</span>
                 <span class="n">charset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">decode_responses</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">retry_on_timeout</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">ssl</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">ssl_keyfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ssl_certfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">ssl_cert_reqs</span><span class="o">=</span><span class="s1">&#39;required&#39;</span><span class="p">,</span> <span class="n">ssl_ca_certs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">max_connections</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">connection_pool</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;db&#39;</span><span class="p">:</span> <span class="n">db</span><span class="p">,</span>
                <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
                <span class="s1">&#39;socket_timeout&#39;</span><span class="p">:</span> <span class="n">socket_timeout</span><span class="p">,</span>
                <span class="s1">&#39;encoding&#39;</span><span class="p">:</span> <span class="n">encoding</span><span class="p">,</span>
                <span class="s1">&#39;encoding_errors&#39;</span><span class="p">:</span> <span class="n">encoding_errors</span><span class="p">,</span>
                <span class="s1">&#39;decode_responses&#39;</span><span class="p">:</span> <span class="n">decode_responses</span><span class="p">,</span>
                <span class="s1">&#39;retry_on_timeout&#39;</span><span class="p">:</span> <span class="n">retry_on_timeout</span><span class="p">,</span>
                <span class="s1">&#39;max_connections&#39;</span><span class="p">:</span> <span class="n">max_connections</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">unix_socket_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">unix_socket_path</span><span class="p">,</span>
                    <span class="s1">&#39;connection_class&#39;</span><span class="p">:</span> <span class="n">UnixDomainSocketConnection</span>
                <span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TCP specific options</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">,</span>
                    <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span><span class="p">,</span>
                    <span class="s1">&#39;socket_connect_timeout&#39;</span><span class="p">:</span> <span class="n">socket_connect_timeout</span><span class="p">,</span>
                    <span class="s1">&#39;socket_keepalive&#39;</span><span class="p">:</span> <span class="n">socket_keepalive</span><span class="p">,</span>
                    <span class="s1">&#39;socket_keepalive_options&#39;</span><span class="p">:</span> <span class="n">socket_keepalive_options</span><span class="p">,</span>
                <span class="p">})</span>

                <span class="k">if</span> <span class="n">ssl</span><span class="p">:</span>
                    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                        <span class="s1">&#39;connection_class&#39;</span><span class="p">:</span> <span class="n">SSLConnection</span><span class="p">,</span>
                        <span class="s1">&#39;ssl_keyfile&#39;</span><span class="p">:</span> <span class="n">ssl_keyfile</span><span class="p">,</span>
                        <span class="s1">&#39;ssl_certfile&#39;</span><span class="p">:</span> <span class="n">ssl_certfile</span><span class="p">,</span>
                        <span class="s1">&#39;ssl_cert_reqs&#39;</span><span class="p">:</span> <span class="n">ssl_cert_reqs</span><span class="p">,</span>
                        <span class="s1">&#39;ssl_ca_certs&#39;</span><span class="p">:</span> <span class="n">ssl_ca_certs</span><span class="p">,</span>
                    <span class="p">})</span>

             <span class="n">connection_pool</span> <span class="o">=</span> <span class="n">ConnectionPool</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection_pool</span> <span class="o">=</span> <span class="n">connection_pool</span></code></pre></td></tr></table>
</div>
</div>
<p>这里暂且跳过连接池的部分，直接关注 <code>SSLConnection</code>. 如果 <code>import ssl</code> 失败，直接抛出异常。否则，就会创建一个安全的 Socket。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ssl</span>
    <span class="n">ssl_available</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">ssl_available</span> <span class="o">=</span> <span class="bp">False</span>

<span class="k">class</span> <span class="nc">SSLConnection</span><span class="p">(</span><span class="n">Connection</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ssl_keyfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ssl_certfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">ssl_cert_reqs</span><span class="o">=</span><span class="s1">&#39;required&#39;</span><span class="p">,</span> <span class="n">ssl_ca_certs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ssl_available</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RedisError</span><span class="p">(</span><span class="s2">&#34;Python wasn&#39;t built with SSL support&#34;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">SSLConnection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">keyfile</span> <span class="o">=</span> <span class="n">ssl_keyfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">certfile</span> <span class="o">=</span> <span class="n">ssl_certfile</span>
        <span class="c1"># ...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cert_reqs</span> <span class="o">=</span> <span class="n">ssl_cert_reqs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ca_certs</span> <span class="o">=</span> <span class="n">ssl_ca_certs</span>

    <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&#34;Wrap the socket with SSL support&#34;</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">SSLConnection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_connect</span><span class="p">()</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span>
                               <span class="n">cert_reqs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cert_reqs</span><span class="p">,</span>
                               <span class="n">keyfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">keyfile</span><span class="p">,</span>
                               <span class="n">certfile</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">certfile</span><span class="p">,</span>
                               <span class="n">ca_certs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ca_certs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sock</span></code></pre></td></tr></table>
</div>
</div>
<p><code>_connect()</code> 这个函数创建了一个 TCP 连接。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">Connection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">err</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket_type</span><span class="p">,</span>
                                      <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">):</span>
            <span class="n">family</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">canonname</span><span class="p">,</span> <span class="n">socket_address</span> <span class="o">=</span> <span class="n">res</span>
            <span class="n">sock</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">socktype</span><span class="p">,</span> <span class="n">proto</span><span class="p">)</span>
                <span class="c1"># TCP_NODELAY</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_TCP</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">TCP_NODELAY</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="c1"># TCP_KEEPALIVE</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket_keepalive</span><span class="p">:</span>
                    <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_KEEPALIVE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket_keepalive_options</span><span class="p">):</span>
                        <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_TCP</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

                <span class="c1"># set the socket_connect_timeout before we connect</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket_connect_timeout</span><span class="p">)</span>

                <span class="c1"># connect</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">socket_address</span><span class="p">)</span>

                <span class="c1"># set the socket_timeout now that we&#39;re connected</span>
                <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket_timeout</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">sock</span>

            <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">_</span>
                <span class="k">if</span> <span class="n">sock</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">err</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">err</span>
        <span class="k">raise</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&#34;socket.getaddrinfo returned an empty list&#34;</span><span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p><code>wrap_socket</code> 给这个 Socket 包了一层 SSL 协议。这个函数已经到达 Python 内置库，咱们继续。</p>

<h1 id="python-ssl">Python SSL</h1>

<p><em>ssl.py</em> 这个文件中，有两个重要的类：<code>SSLContext</code> 和 <code>SSLSocket</code>。<code>wrap_socket</code> 做的事情就是填充 <code>SSLContext</code>，然后返回一个 <code>SSLSocket</code>。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">certfile</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">server_side</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">cert_reqs</span><span class="o">=</span><span class="n">CERT_NONE</span><span class="p">,</span>
                <span class="n">ssl_version</span><span class="o">=</span><span class="n">PROTOCOL_TLS</span><span class="p">,</span> <span class="n">ca_certs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                <span class="n">do_handshake_on_connect</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">suppress_ragged_eofs</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">ciphers</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">server_side</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">certfile</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;certfile must be specified for server-side &#34;</span>
                         <span class="s2">&#34;operations&#34;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">keyfile</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">certfile</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;certfile must be specified&#34;</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">SSLContext</span><span class="p">(</span><span class="n">ssl_version</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">cert_reqs</span>
    <span class="k">if</span> <span class="n">ca_certs</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">ca_certs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">certfile</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">certfile</span><span class="p">,</span> <span class="n">keyfile</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ciphers</span><span class="p">:</span>
        <span class="n">context</span><span class="o">.</span><span class="n">set_ciphers</span><span class="p">(</span><span class="n">ciphers</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span>
        <span class="n">sock</span><span class="o">=</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="n">server_side</span><span class="p">,</span>
        <span class="n">do_handshake_on_connect</span><span class="o">=</span><span class="n">do_handshake_on_connect</span><span class="p">,</span>
        <span class="n">suppress_ragged_eofs</span><span class="o">=</span><span class="n">suppress_ragged_eofs</span>
    <span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p><code>SSLContext</code> 也是调用 <code>SSLSocket</code> 的 <code>_create</code> 工厂函数来创建对象。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="k">class</span> <span class="nc">SSLContext</span><span class="p">(</span><span class="n">_SSLContext</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrap_socket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                    <span class="n">do_handshake_on_connect</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">suppress_ragged_eofs</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                    <span class="n">server_hostname</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1"># SSLSocket class handles server_hostname encoding before it calls</span>
        <span class="c1"># ctx._wrap_socket()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sslsocket_class</span><span class="o">.</span><span class="n">_create</span><span class="p">(</span>
            <span class="n">sock</span><span class="o">=</span><span class="n">sock</span><span class="p">,</span>
            <span class="n">server_side</span><span class="o">=</span><span class="n">server_side</span><span class="p">,</span>
            <span class="n">do_handshake_on_connect</span><span class="o">=</span><span class="n">do_handshake_on_connect</span><span class="p">,</span>
            <span class="n">suppress_ragged_eofs</span><span class="o">=</span><span class="n">suppress_ragged_eofs</span><span class="p">,</span>
            <span class="n">server_hostname</span><span class="o">=</span><span class="n">server_hostname</span><span class="p">,</span>
            <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span>
        <span class="p">)</span></code></pre></td></tr></table>
</div>
</div>
<p>到了 <code>SSLSocket</code> 里， 最重要的就是握手过程，这是由 <code>do_handshake()</code> 函数实现的。握手的过程，<a href="http://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html">图解SSL/TLS协议
</a> 有图文并茂的展示。</p>
    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/zh/post/exceptions-thrown-by-jedis/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Jedis 的常见异常</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/zh/post/redis-as-an-lru-cache/">
            <span class="next-text nav-default">Redis 用作 LRU 缓存</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'guoqing';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:hellokangning@hotmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://www.linkedin.com/in/guoqing-geng-9032b820/" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="https://github.com/hellokangning" class="iconfont icon-github" title="github"></a>
      <a href="https://www.douban.com/people/hellokangning/" class="iconfont icon-douban" title="douban"></a>
      <a href="https://www.instagram.com/hellokangning/" class="iconfont icon-instagram" title="instagram"></a>
  <a href="https://hellokangning.github.io/zh/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2016 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Guoqing Geng</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-105833321-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>

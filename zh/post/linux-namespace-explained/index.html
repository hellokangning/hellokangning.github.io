<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Linux Namespace Explained - Qing&#39;s Landing</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Guoqing Geng" /><meta name="description" content="æœ€è¿‘åœ¨åš Kubernetes Security ç›¸å…³çš„å·¥ä½œã€‚ä½œä¸ºä¸€ä¸ª Kubernetes æ–°æ‰‹ï¼Œåˆšçœ‹åˆ° yaml æ–‡ä»¶ä¸­çš„ namespace æ—¶ï¼Œå¾ˆå®¹æ˜“å’Œ Linux çš„ Namespace ææ··ã€‚åŠ ä¸Šåœ¨è¯» Kubernetes æ–‡æ¡£çš„æ—¶å€™ï¼Œæ€»æ—¶ä¸æ—¶çœ‹åˆ° Linux Namespace çš„å­—æ ·å°±æ›´åŠ å›°æƒ‘èµ·æ¥ã€‚ä»¥æ­¤ä¸ºå¥‘æœºï¼Œæ­£å¥½æŠŠ Linux Namespace å†å¥½å¥½æ¢³ç†ä¸€ä¸‹ï¼Œè§£å¼€å¿ƒä¸­çš„è°œå›¢ï¼š
 Linux çš„ Namespace æ˜¯å¦‚ä½•å®ç°èµ„æºçš„éš”ç¦» Linux ä¸‹å“ªäº›èµ„æºå¯ä»¥æŒ‰ç…§ Namespace ç»„ç»‡ï¼Œå¦‚ä½•ç»„ç»‡ Container å“ªäº›åœ°æ–¹ç”¨åˆ°äº† Linux Namespace " />






<meta name="generator" content="Hugo 0.64.1 with theme even" />


<link rel="canonical" href="https://hellokangning.github.io/zh/post/linux-namespace-explained/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Linux Namespace Explained" />
<meta property="og:description" content="æœ€è¿‘åœ¨åš Kubernetes Security ç›¸å…³çš„å·¥ä½œã€‚ä½œä¸ºä¸€ä¸ª Kubernetes æ–°æ‰‹ï¼Œåˆšçœ‹åˆ° yaml æ–‡ä»¶ä¸­çš„ namespace æ—¶ï¼Œå¾ˆå®¹æ˜“å’Œ Linux çš„ Namespace ææ··ã€‚åŠ ä¸Šåœ¨è¯» Kubernetes æ–‡æ¡£çš„æ—¶å€™ï¼Œæ€»æ—¶ä¸æ—¶çœ‹åˆ° Linux Namespace çš„å­—æ ·å°±æ›´åŠ å›°æƒ‘èµ·æ¥ã€‚ä»¥æ­¤ä¸ºå¥‘æœºï¼Œæ­£å¥½æŠŠ Linux Namespace å†å¥½å¥½æ¢³ç†ä¸€ä¸‹ï¼Œè§£å¼€å¿ƒä¸­çš„è°œå›¢ï¼š

Linux çš„ Namespace æ˜¯å¦‚ä½•å®ç°èµ„æºçš„éš”ç¦»
Linux ä¸‹å“ªäº›èµ„æºå¯ä»¥æŒ‰ç…§ Namespace ç»„ç»‡ï¼Œå¦‚ä½•ç»„ç»‡
Container å“ªäº›åœ°æ–¹ç”¨åˆ°äº† Linux Namespace
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hellokangning.github.io/zh/post/linux-namespace-explained/" />
<meta property="article:published_time" content="2019-11-27T20:12:20+08:00" />
<meta property="article:modified_time" content="2019-11-27T20:12:20+08:00" />
<meta itemprop="name" content="Linux Namespace Explained">
<meta itemprop="description" content="æœ€è¿‘åœ¨åš Kubernetes Security ç›¸å…³çš„å·¥ä½œã€‚ä½œä¸ºä¸€ä¸ª Kubernetes æ–°æ‰‹ï¼Œåˆšçœ‹åˆ° yaml æ–‡ä»¶ä¸­çš„ namespace æ—¶ï¼Œå¾ˆå®¹æ˜“å’Œ Linux çš„ Namespace ææ··ã€‚åŠ ä¸Šåœ¨è¯» Kubernetes æ–‡æ¡£çš„æ—¶å€™ï¼Œæ€»æ—¶ä¸æ—¶çœ‹åˆ° Linux Namespace çš„å­—æ ·å°±æ›´åŠ å›°æƒ‘èµ·æ¥ã€‚ä»¥æ­¤ä¸ºå¥‘æœºï¼Œæ­£å¥½æŠŠ Linux Namespace å†å¥½å¥½æ¢³ç†ä¸€ä¸‹ï¼Œè§£å¼€å¿ƒä¸­çš„è°œå›¢ï¼š

Linux çš„ Namespace æ˜¯å¦‚ä½•å®ç°èµ„æºçš„éš”ç¦»
Linux ä¸‹å“ªäº›èµ„æºå¯ä»¥æŒ‰ç…§ Namespace ç»„ç»‡ï¼Œå¦‚ä½•ç»„ç»‡
Container å“ªäº›åœ°æ–¹ç”¨åˆ°äº† Linux Namespace
">
<meta itemprop="datePublished" content="2019-11-27T20:12:20&#43;08:00" />
<meta itemprop="dateModified" content="2019-11-27T20:12:20&#43;08:00" />
<meta itemprop="wordCount" content="2998">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Linux Namespace Explained"/>
<meta name="twitter:description" content="æœ€è¿‘åœ¨åš Kubernetes Security ç›¸å…³çš„å·¥ä½œã€‚ä½œä¸ºä¸€ä¸ª Kubernetes æ–°æ‰‹ï¼Œåˆšçœ‹åˆ° yaml æ–‡ä»¶ä¸­çš„ namespace æ—¶ï¼Œå¾ˆå®¹æ˜“å’Œ Linux çš„ Namespace ææ··ã€‚åŠ ä¸Šåœ¨è¯» Kubernetes æ–‡æ¡£çš„æ—¶å€™ï¼Œæ€»æ—¶ä¸æ—¶çœ‹åˆ° Linux Namespace çš„å­—æ ·å°±æ›´åŠ å›°æƒ‘èµ·æ¥ã€‚ä»¥æ­¤ä¸ºå¥‘æœºï¼Œæ­£å¥½æŠŠ Linux Namespace å†å¥½å¥½æ¢³ç†ä¸€ä¸‹ï¼Œè§£å¼€å¿ƒä¸­çš„è°œå›¢ï¼š

Linux çš„ Namespace æ˜¯å¦‚ä½•å®ç°èµ„æºçš„éš”ç¦»
Linux ä¸‹å“ªäº›èµ„æºå¯ä»¥æŒ‰ç…§ Namespace ç»„ç»‡ï¼Œå¦‚ä½•ç»„ç»‡
Container å“ªäº›åœ°æ–¹ç”¨åˆ°äº† Linux Namespace
"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/zh/" class="logo">Qing&#39;s Landing</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/zh/">
        <li class="mobile-menu-item">é¦–é¡µ</li>
      </a><a href="/zh/post/">
        <li class="mobile-menu-item">å½’æ¡£</li>
      </a><a href="/zh/categories/">
        <li class="mobile-menu-item">åˆ†ç±»</li>
      </a><a href="/zh/tags/">
        <li class="mobile-menu-item">æ ‡ç­¾</li>
      </a><a href="/en/">
        <li class="mobile-menu-item">EN</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/zh/" class="logo">Qing&#39;s Landing</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/zh/">é¦–é¡µ</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/zh/post/">å½’æ¡£</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/zh/categories/">åˆ†ç±»</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/zh/tags/">æ ‡ç­¾</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/en/">EN</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Linux Namespace Explained</h1>

      <div class="post-meta">
        <span class="post-time"> Nov 27, 2019 </span>
        <div class="post-category">
            <a href="/zh/categories/%E5%AE%B9%E5%99%A8/"> å®¹å™¨ </a>
            </div>
          <span class="more-meta"> 2998 words </span>
          <span class="more-meta"> 6 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#è‹±é›„è¯ç”Ÿ">è‹±é›„è¯ç”Ÿ</a></li>
    <li><a href="#å®ç°">å®ç°</a></li>
    <li><a href="#namespace-çš„-api">Namespace çš„ API</a>
      <ul>
        <li><a href="#clone-åˆ›å»ºæ–°-namespace">clone() åˆ›å»ºæ–° namespace</a></li>
        <li><a href="#setns-åŠ å…¥å·²æœ‰-namespace">setns() åŠ å…¥å·²æœ‰ namespace</a></li>
        <li><a href="#unshare-ç¦»å¼€-namespace">unshare() ç¦»å¼€ namespace</a></li>
      </ul>
    </li>
    <li><a href="#procpidns-ç›®å½•">/proc/[pid]/ns/ ç›®å½•</a></li>
    <li><a href="#pid-namespace">PID Namespace</a></li>
    <li><a href="#mount-namespace">Mount Namespace</a></li>
    <li><a href="#user-namespace">User Namespace</a></li>
    <li><a href="#network-namespace">Network Namespace</a></li>
    <li><a href="#uts-namespace">UTS Namespace</a></li>
    <li><a href="#ipc-namespace">IPC Namespace</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>æœ€è¿‘åœ¨åš Kubernetes Security ç›¸å…³çš„å·¥ä½œã€‚ä½œä¸ºä¸€ä¸ª Kubernetes æ–°æ‰‹ï¼Œåˆšçœ‹åˆ° yaml æ–‡ä»¶ä¸­çš„ namespace æ—¶ï¼Œå¾ˆå®¹æ˜“å’Œ Linux çš„ Namespace ææ··ã€‚åŠ ä¸Šåœ¨è¯» Kubernetes æ–‡æ¡£çš„æ—¶å€™ï¼Œæ€»æ—¶ä¸æ—¶çœ‹åˆ° Linux Namespace çš„å­—æ ·å°±æ›´åŠ å›°æƒ‘èµ·æ¥ã€‚ä»¥æ­¤ä¸ºå¥‘æœºï¼Œæ­£å¥½æŠŠ Linux Namespace å†å¥½å¥½æ¢³ç†ä¸€ä¸‹ï¼Œè§£å¼€å¿ƒä¸­çš„è°œå›¢ï¼š</p>
<ul>
<li>Linux çš„ Namespace æ˜¯å¦‚ä½•å®ç°èµ„æºçš„éš”ç¦»</li>
<li>Linux ä¸‹å“ªäº›èµ„æºå¯ä»¥æŒ‰ç…§ Namespace ç»„ç»‡ï¼Œå¦‚ä½•ç»„ç»‡</li>
<li>Container å“ªäº›åœ°æ–¹ç”¨åˆ°äº† Linux Namespace</li>
</ul>
<h2 id="è‹±é›„è¯ç”Ÿ">è‹±é›„è¯ç”Ÿ</h2>
<p>ä¼ ç»Ÿçš„ Linux åŠå…¶è¡ç”Ÿçš„ UNIX å˜ä½“ä¸­ï¼Œè®¸å¤šèµ„æºæ˜¯å…¨å±€ç®¡ç†çš„ã€‚ä¾‹å¦‚ï¼Œç³»ç»Ÿä¸­çš„æ‰€æœ‰è¿›ç¨‹æŒ‰ç…§æƒ¯ä¾‹æ˜¯é€šè¿‡ PID æ ‡è¯†çš„ï¼Œè¿™æ„å‘³ç€å†…æ ¸å¿…é¡»ç®¡ç†ä¸€ä¸ªå…¨å±€çš„ PID åˆ—è¡¨ã€‚è€Œä¸”ï¼Œæ‰€æœ‰è°ƒç”¨è€…é€šè¿‡ <code>uname</code> ç³»ç»Ÿè°ƒç”¨è¿”å›çš„ç³»ç»Ÿç›¸å…³ä¿¡æ¯ï¼ˆåŒ…æ‹¬ç³»ç»Ÿåç§°å’Œæœ‰å…³å†…æ ¸çš„ä¸€äº›ä¿¡æ¯ï¼‰éƒ½æ˜¯ç›¸åŒçš„ã€‚ç”¨æˆ· ID çš„ç®¡ç†æ–¹å¼ç±»ä¼¼ï¼Œå³å„ä¸ªç”¨æˆ·æ˜¯é€šè¿‡ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ UID å·æ ‡è¯†ã€‚</p>
<p>å…¨å±€ ID ç»™å†…æ ¸æå¤§çš„é€‰æ‹©æƒï¼Œå¯ä»¥é€šè¿‡ ID æ¥å…è®¸æˆ–æ‹’ç»æŸäº›æƒé™ã€‚UID ä¸º 0 çš„ root ç”¨æˆ·å¯ä»¥åšäººå’Œäº‹ï¼Œä½†å…¶ä»– UID ä¼šå—é™ã€‚ä¾‹å¦‚ UID ä¸º n çš„ç”¨æˆ·ï¼Œä¸å…è®¸æ€æ­»å±äºç”¨æˆ· m çš„è¿›ç¨‹ï¼ˆm â‰  n ï¼‰ã€‚ä½†è¿™ä¸èƒ½é˜²æ­¢ç”¨æˆ·çœ‹åˆ°å½¼æ­¤ï¼Œå³ç”¨æˆ· n å¯ä»¥çœ‹åˆ°å¦ä¸€ä¸ªç”¨æˆ· m ä¹Ÿåœ¨è®¡ç®—æœºä¸Šæ´»åŠ¨ã€‚è¿™ç§æ•ˆæœåœ¨æŸäº›æƒ…å†µä¸‹æ˜¯ä¸å¯å–çš„ã€‚</p>
<p>Namespace æä¾›äº†è™šæ‹ŸåŒ–çš„ä¸€ç§è½»é‡çº§å½¢å¼ï¼Œå®ƒåªä½¿ç”¨ä¸€ä¸ªå†…æ ¸åœ¨ä¸€å°ç‰©ç†æœºä¸Šè¿è¡Œï¼Œå°±å¯ä»¥å°†ä¸Šè¿°çš„å…¨å±€èµ„æºç»„ç»‡èµ·æ¥ã€‚è¿™ä½¿å¾—å¯ä»¥å°†ä¸€ç»„è¿›ç¨‹æ”¾ç½®åˆ°å®¹å™¨ä¸­ï¼Œå„ä¸ªå®¹å™¨å½¼æ­¤éš”ç¦»ã€‚éš”ç¦»å¯ä»¥ä½¿å®¹å™¨çš„æˆå‘˜ä¸å…¶ä»–å®¹å™¨æ¯«æ— å…³ç³»ã€‚ä½†ä¹Ÿå¯ä»¥é€šè¿‡å…è®¸å®¹å™¨è¿›è¡Œä¸€å®šçš„å…±äº«ï¼Œæ¥é™ä½å®¹å™¨ä¹‹é—´çš„åˆ†éš”ã€‚ä¾‹å¦‚ï¼Œå®¹å™¨å¯ä»¥è®¾ç½®ä¸ºä½¿ç”¨è‡ªèº«çš„ PID é›†åˆï¼Œä½†ä»ç„¶ä¸å…¶ä»–å®¹å™¨å…±äº«éƒ¨åˆ†æ–‡ä»¶ç³»ç»Ÿã€‚</p>
<h2 id="å®ç°">å®ç°</h2>
<p>Namespace çš„å®ç°éœ€è¦ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>æ¯ä¸ªå­ç³»ç»Ÿçš„ namespace ç»“æ„ï¼Œå°†æ­¤å‰æ‰€æœ‰çš„å…¨å±€ç»„ä»¶åŒ…è£…åˆ° namespace ä¸­</li>
<li>å°†ç»™å®šè¿›ç¨‹å…³è”åˆ°æ‰€å±å„ä¸ª namespace çš„æœºåˆ¶</li>
</ol>
<blockquote>
<p>æœ¬æ–‡é‡‡ç”¨çš„æºç æ˜¯å†…æ ¸ 5.4</p>
</blockquote>
<p>Linuxå†…æ ¸ä¸­è¿›ç¨‹ç”¨ <code>task_struct</code> ç»“æ„ä½“è¡¨ç¤ºï¼Œæˆ‘ä»¬ç§°ä¸ºè¿›ç¨‹æè¿°ç¬¦ã€‚è¯¥ç»“æ„ä½“å®šä¹‰åœ¨ <code>sched.h</code> ä¸­ï¼Œè®°å½•äº†è¿›ç¨‹ç›¸å…³çš„æ‰€æœ‰ä¿¡æ¯ï¼Œæ¯”å¦‚è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œè¿›ç¨‹çŠ¶æ€ï¼Œæ‰“å¼€çš„æ–‡ä»¶ç­‰ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="c1">// sched.h
</span><span class="c1"></span>
<span class="k">struct</span> <span class="n">task_struct</span> <span class="p">{</span>
	<span class="cm">/* Filesystem information: */</span>
	<span class="k">struct</span> <span class="n">fs_struct</span>		<span class="o">*</span><span class="n">fs</span><span class="p">;</span>

	<span class="cm">/* Open file information: */</span>
	<span class="k">struct</span> <span class="n">files_struct</span>		<span class="o">*</span><span class="n">files</span><span class="p">;</span>

	<span class="cm">/* Namespaces: */</span>
	<span class="k">struct</span> <span class="n">nsproxy</span>			<span class="o">*</span><span class="n">nsproxy</span><span class="p">;</span>

    <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ <code>nsproxy</code> å˜é‡ã€‚<code>nsproxy</code> ç»“æ„ä½“åŒ…å«æŒ‡å‘è¿›ç¨‹æ‰€å± Namespace çš„æ‰€æœ‰æŒ‡é’ˆï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<table>
<thead>
<tr>
<th>Namespace</th>
<th>ç³»ç»Ÿè°ƒç”¨å‚æ•°</th>
<th>éš”ç¦»å†…å®¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>UTS</td>
<td>CLONE_NEWUTS</td>
<td>ä¸»æœºåä¸åŸŸå</td>
</tr>
<tr>
<td>IPC</td>
<td>CLONE_NEWIPC</td>
<td>ä¿¡å·é‡ã€æ¶ˆæ¯é˜Ÿåˆ—å’Œå…±äº«å†…å­˜</td>
</tr>
<tr>
<td>PID</td>
<td>CLONE_NEWPID</td>
<td>è¿›ç¨‹ç¼–å·</td>
</tr>
<tr>
<td>Network</td>
<td>CLONE_NEWNET</td>
<td>ç½‘ç»œè®¾å¤‡ã€ç½‘ç»œæ ˆã€ç«¯å£ç­‰ç­‰</td>
</tr>
<tr>
<td>Mount</td>
<td>CLONE_NEWNS</td>
<td>æŒ‚è½½ç‚¹ï¼ˆæ–‡ä»¶ç³»ç»Ÿï¼‰</td>
</tr>
<tr>
<td>User</td>
<td>CLONE_NEWUSER</td>
<td>ç”¨æˆ·å’Œç”¨æˆ·ç»„</td>
</tr>
</tbody>
</table>
<p><code>nsproxy</code> ç”± namespace ä¸‹çš„æ‰€æœ‰è¿›ç¨‹å…±äº«ï¼Œnamespace å†å°è£…äº†å„ç§èµ„æºï¼Œè¿›ç¨‹åªèƒ½æŸ¥çœ‹å’Œæ“ä½œç»‘å®šåœ¨ namespace çš„èµ„æºã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="c1">// nsproxy.h
</span><span class="c1"></span>
<span class="k">struct</span> <span class="n">nsproxy</span> <span class="p">{</span>
	<span class="n">atomic_t</span> <span class="n">count</span><span class="p">;</span> 
	<span class="k">struct</span> <span class="n">uts_namespace</span> <span class="o">*</span><span class="n">uts_ns</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="o">*</span><span class="n">ipc_ns</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mnt_namespace</span> <span class="o">*</span><span class="n">mnt_ns</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pid_namespace</span> <span class="o">*</span><span class="n">pid_ns_for_children</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net</span> 	     <span class="o">*</span><span class="n">net_ns</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cgroup_namespace</span> <span class="o">*</span><span class="n">cgroup_ns</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œç‰¹åˆ«è¯´æ˜ä¸‹:</p>
<ul>
<li>è¿›ç¨‹çš„ pid namespace é€šè¿‡ <code>task_active_pid_ns</code> è·å–ã€‚<code>nsproxy</code> ç»“æ„ä¸­çš„ <code>pid_namespae</code> æ˜¯ç»™å­è¿›ç¨‹ä½¿ç”¨çš„ã€‚</li>
<li>User namespace æ²¡æœ‰ç›´æ¥å‡ºç°åœ¨ <code>nsproxy</code> ä¸­ï¼Œä½† <code>**_namespace</code> éƒ½æœ‰åŒ…å« user namespace çš„æŒ‡é’ˆã€‚</li>
<li>å®é™…ä¸Šï¼Œå†…æ ¸ä» 4.6 å¼€å§‹å¼•å…¥äº† cgroup namespaceï¼Œæœ¬æ–‡å°±å…ˆæ è¿‡ä¸è¡¨ï¼Œç•™å¾…ä»¥åæ¢ç´¢ã€‚</li>
</ul>
<h2 id="namespace-çš„-api">Namespace çš„ API</h2>
<p>æœ‰ä¸¤ç§æ–¹æ³•åˆ›å»º namespace:</p>
<ol>
<li>åœ¨ç”¨ <code>fork</code> æˆ– <code>clone</code> ç³»ç»Ÿè°ƒç”¨åˆ›å»ºæ–°è¿›ç¨‹æ—¶ï¼Œæœ‰ç‰¹å®šçš„é€‰é¡¹å¯ä»¥æ§åˆ¶æ˜¯ä¸çˆ¶è¿›ç¨‹å…±äº« namespaceï¼Œè¿˜æ˜¯å»ºç«‹æ–°çš„ namespaceã€‚</li>
<li><code>unshare</code> ç³»ç»Ÿè°ƒç”¨å°†è¿›ç¨‹çš„æŸäº›éƒ¨åˆ†ä»çˆ¶è¿›ç¨‹åˆ†ç¦»ï¼Œå…¶ä¸­ä¹ŸåŒ…æ‹¬ namespaceã€‚</li>
</ol>
<p>è¿™åº•ä¸‹ç”¨åˆ°ä¸‰ä¸ªå‡½æ•° <code>clone()</code>ã€<code>setns()</code> ä»¥åŠ <code>unshare()</code>ï¼Œè®©æˆ‘ä»¬é€ä¸ªè§£æã€‚</p>
<h3 id="clone-åˆ›å»ºæ–°-namespace"><code>clone()</code> åˆ›å»ºæ–° namespace</h3>
<p><code>clone()</code> å‡½æ•°çš„ manual åœ¨ <a href="http://man7.org/linux/man-pages/man2/clone.2.html">CLONE(2)</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">clone</span><span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">child_stack</span><span class="p">,</span>
                 <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="p">.</span><span class="p">.</span><span class="p">.</span>
                 <span class="cm">/* pid_t *ptid, void *newtls, pid_t *ctid */</span> <span class="p">)</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>clone()</code> å¯ä»¥çœ‹ä½œæ˜¯ä¼ ç»Ÿ UNIX <code>fork</code> çš„é€šç”¨ç‰ˆæœ¬ï¼Œä¸¤è€…éƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œä¹Ÿåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ namespaceã€‚ä¸åŒä¹‹å¤„åœ¨äºï¼Œ<code>clone()</code> å…è®¸å­è¿›ç¨‹å…±äº«çˆ¶è¿›ç¨‹çš„éƒ¨åˆ†æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œæ¯”å¦‚è™šæ‹Ÿåœ°å€ç©ºé—´ã€æ–‡ä»¶æè¿°ç¬¦ç­‰ã€‚é€šè¿‡ <code>flags</code> å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶çˆ¶å­è¿›ç¨‹ä¹‹é—´å…±äº«çš„å†…å®¹ã€‚</p>
<p><code>clone()</code> çš„å‡ ä¸ªå‚æ•°ï¼š</p>
<ul>
<li><code>fn</code> ä¼ å…¥å­è¿›ç¨‹è¿è¡Œçš„ä¸»å‡½æ•°</li>
<li><code>child_stack</code> ä¼ å…¥å­è¿›ç¨‹ä½¿ç”¨çš„æ ˆç©ºé—´ï¼Œå› ä¸ºå­è¿›ç¨‹å¯èƒ½å’Œçˆ¶è¿›ç¨‹å…±äº«å†…å­˜</li>
<li><code>flags</code> è¡¨ç¤ºä½¿ç”¨å“ªäº› <code>CLONE_*</code> æ ‡å¿—ä½</li>
<li><code>arg</code> å³ä¼ å…¥ <code>fn</code> å‡½æ•°çš„å‚æ•°</li>
</ul>
<h3 id="setns-åŠ å…¥å·²æœ‰-namespace"><code>setns()</code> åŠ å…¥å·²æœ‰ namespace</h3>
<p>é€šè¿‡ <a href="http://man7.org/linux/man-pages/man2/setns.2.html"><code>setns()</code></a> å¯ä»¥åŠ å…¥ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ namespaceã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">setns</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nstype</span><span class="p">)</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>å…¶ä¸­ï¼Œ</p>
<ul>
<li><code>fd</code> æ˜¯æŒ‡å‘ <code>/proc/[pid]/ns/</code> ç›®å½•çš„æ–‡ä»¶æè¿°ç¬¦</li>
<li><code>nstype</code> ä½¿ç”¨ CLONE_* æ ‡å¿—ä½çº¦æŸäº† namespace çš„ç±»å‹</li>
</ul>
<h3 id="unshare-ç¦»å¼€-namespace"><code>unshare()</code> ç¦»å¼€ namespace</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">unshare</span><span class="p">(</span><span class="kt">int</span> <span class="n">flags</span><span class="p">)</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>unshare()</code> å°†è¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰ä»å®ƒè¢«å…¶ä»–è¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰å…±äº«çš„æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­åˆ†ç¦»å‡ºæ¥ã€‚<code>flags</code> å‚æ•°æ˜¯ <code>CLONE_*</code> çš„ä½æ©ç ã€‚</p>
<h2 id="procpidns-ç›®å½•">/proc/[pid]/ns/ ç›®å½•</h2>
<p>å‰æ–‡è¯´åˆ°äº† /proc/[pid]/ns/ ç›®å½•ï¼Œæ¯ä¸ªè¿›ç¨‹åœ¨è¯¥ç›®å½•ä¸‹éƒ½æœ‰ä¸€ä¸ªå­ç›®å½•ï¼Œæ ‡è¯†ç€æ‰€å±çš„ namespaceã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">$ ls -l /proc/$$/ns
total 0
lrwxrwxrwx. 1 mtk mtk 0 Apr 28 12:46 cgroup -&gt; cgroup:[4026531835]
lrwxrwxrwx. 1 mtk mtk 0 Apr 28 12:46 ipc -&gt; ipc:[4026531839]
lrwxrwxrwx. 1 mtk mtk 0 Apr 28 12:46 mnt -&gt; mnt:[4026531840]
lrwxrwxrwx. 1 mtk mtk 0 Apr 28 12:46 net -&gt; net:[4026531969]
lrwxrwxrwx. 1 mtk mtk 0 Apr 28 12:46 pid -&gt; pid:[4026531836]
lrwxrwxrwx. 1 mtk mtk 0 Apr 28 12:46 pid_for_children -&gt; pid:[4026531834]
lrwxrwxrwx. 1 mtk mtk 0 Apr 28 12:46 user -&gt; user:[4026531837]
rwxrwxrwx. 1 mtk mtk 0 Apr 28 12:46 uts -&gt; uts:[4026531838]
</code></pre></td></tr></table>
</div>
</div><p>ä¸‹é¢ï¼Œæˆ‘ä»¬å¯¹ 6 ç§ namespace ä¸€ä¸€æ‹†è§£ã€‚</p>
<h2 id="pid-namespace">PID Namespace</h2>
<p>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ª PIDï¼ŒPID namespace å°† PID éš”ç¦»å¼€æ¥ã€‚è¿™æ„å‘³ç€åœ¨ä¸åŒ PID namespace ä¸‹çš„è¿›ç¨‹å¯ä»¥æœ‰ç›¸åŒçš„ PIDã€‚Container å¯ä»¥ä¾é  PID namespace æ¥ suspend æˆ– resume ä¸€ä¸ª namespace ä¸‹çš„è¿›ç¨‹é›†åˆï¼Œè€Œä¸å½±å“å…¶ä»– namespace çš„è¿›ç¨‹ã€‚</p>
<p><code>fork</code> å’Œ <code>clone</code> åˆ›å»ºçš„è¿›ç¨‹ï¼Œå¸¦æœ‰ä¸¤ä¸ª PIDï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯ namespace ä¸­å”¯ä¸€ PIDï¼Œå¦ä¸€ä¸ªæ˜¯ host ç³»ç»Ÿä¸Šçš„ PIDã€‚PID namespace çš„ PID ä» 2 å¼€å§‹åˆ†é…ï¼Œ1 è¿™ä¸ªä½ç½®ç•™ç»™ init è¿›ç¨‹ï¼Œå®ƒæ˜¯æ‰€æœ‰å­¤å„¿è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ã€‚å¦‚æœ init è¿›ç¨‹ç»ˆæ­¢äº†ï¼Œé‚£ä¹ˆå†…æ ¸ä¼šé€šè¿‡ <strong>SIGKILL</strong> æ¥ç»ˆæ­¢è¯¥ namespace ä¸‹çš„æ‰€æœ‰è¿›ç¨‹ã€‚</p>
<p>PID namespace å¯ä»¥ç»„ç»‡ä¸ºå±‚æ¬¡ï¼Œä¹Ÿå¯ä»¥ä¸ºéå±‚æ¬¡ã€‚å†…æ ¸ä¸ºæ‰€æœ‰çš„ PID namespace ç»´æŠ¤äº†ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ï¼Œæœ€é¡¶å±‚çš„æ˜¯ç³»ç»Ÿåˆå§‹æ—¶åˆ›å»ºçš„ root namespaceã€‚åœ¨å±‚æ¬¡ç»„ç»‡çš„ namespace ä¸­ï¼Œçˆ¶ namespace èƒ½å¤Ÿçœ‹åˆ°å­ namespace çš„æ‰€æœ‰è¿›ç¨‹ï¼Œå› ä¸ºåè€…è¿›ç¨‹çš„ PID ä¼šæ˜ å°„åˆ°çˆ¶ namespace ä¸­ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>pid_namespace</code> ç»“æ„ä½“ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">pid_namespace</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pid_allocated</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">child_reaper</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pid_namespace</span> <span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">user_namespace</span> <span class="o">*</span><span class="n">user_ns</span><span class="p">;</span>

	<span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span> <span class="n">__randomize_layout</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p>å®ƒåŒ…æ‹¬ï¼š</p>
<ul>
<li>PID</li>
<li>å­è¿›ç¨‹çš„æŒ‡é’ˆ</li>
<li>çˆ¶ PID namespace çš„æŒ‡é’ˆ</li>
<li>æ‰€å± User namespace çš„æŒ‡é’ˆ</li>
</ul>
<h2 id="mount-namespace">Mount Namespace</h2>
<p>Mount namespace éš”ç¦»çš„æ˜¯æŒ‚è½½ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸åŒ namesapce ä¸‹çš„è¿›ç¨‹çœ‹åˆ°ä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿè§†å›¾ã€‚å› æ­¤ï¼ŒMount namespace ç”¨æ¥å®ç°å®¹å™¨ä¸­æ–‡ä»¶ç³»ç»Ÿçš„éš”ç¦»ã€‚å¼•å…¥ Mount namespace ä¹‹åï¼Œmount å’Œ umount è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨å°±ä¸ä¼šåœ¨ global çš„ æŒ‚è½½ç‚¹ä¸Šæ‰§è¡Œäº†ã€‚</p>
<p>Mount namespace æ˜¯å†…æ ¸ 2.4.19 æ—¶å¼•è¿›çš„ï¼Œä»£è¡¨å¸¸é‡æ˜¯ CLONE_NEWNSï¼Œæ˜¯æ²¡æœ‰è€ƒè™‘åˆ°ä¹‹åçš„æ‰©å±•æ€§ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">mnt_namespace</span> <span class="p">{</span>
	<span class="n">atomic_t</span>		<span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ns_common</span>	<span class="n">ns</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mount</span> <span class="o">*</span>	<span class="n">root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">user_namespace</span>	<span class="o">*</span><span class="n">user_ns</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucounts</span>		<span class="o">*</span><span class="n">ucounts</span><span class="p">;</span>
	<span class="n">u64</span>			<span class="n">seq</span><span class="p">;</span>	<span class="cm">/* Sequence number to prevent loops */</span>
	<span class="n">wait_queue_head_t</span> <span class="n">poll</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">event</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">mounts</span><span class="p">;</span> <span class="cm">/* # of mounts in the namespace */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">pending_mounts</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__randomize_layout</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>mnt_namespace</code> ç»“æ„ä½“ä¸­æœ‰ï¼š</p>
<ul>
<li>User namespace çš„æŒ‡é’ˆ</li>
<li>æ‰€æœ‰ mount çš„æ–‡ä»¶æ ‘çš„ root æŒ‡é’ˆ</li>
</ul>
<h2 id="user-namespace">User Namespace</h2>
<p>User namespace éš”ç¦»äº† UID å’Œ GIDã€‚æ¢å¥è¯è¯´ï¼Œè¿›ç¨‹çš„ UID å’Œ GID åœ¨ namespace å†…å¤–å¯ä»¥ä¸åŒã€‚è¿™æ„å‘³ç€ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥åœ¨ user namespace ä¹‹å¤–æœ‰ä¸€ä¸ª unprivileged UIDï¼ŒåŒæ—¶åœ¨ä¸€ä¸ª user namespace å†…æœ‰ä¸º 0 çš„ privileged UIDã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">user_namespace</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">uid_gid_map</span>	<span class="n">uid_map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uid_gid_map</span>	<span class="n">gid_map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uid_gid_map</span>	<span class="n">projid_map</span><span class="p">;</span>
	<span class="n">atomic_t</span>		<span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">user_namespace</span>	<span class="o">*</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">level</span><span class="p">;</span>
	<span class="n">kuid_t</span>			<span class="n">owner</span><span class="p">;</span>
	<span class="n">kgid_t</span>			<span class="n">group</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ns_common</span>	<span class="n">ns</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">flags</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ucounts</span>		<span class="o">*</span><span class="n">ucounts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ucount_max</span><span class="p">[</span><span class="n">UCOUNT_COUNTS</span><span class="p">]</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__randomize_layout</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>user_namespace</code> ä¸­æœ‰ï¼š</p>
<ul>
<li>çˆ¶ user namespace çš„æŒ‡é’ˆ</li>
<li>UID å’Œ GID çš„ map</li>
</ul>
<h2 id="network-namespace">Network Namespace</h2>
<p>Network namespace éš”ç¦»äº†ç½‘ç»œèµ„æºï¼ŒåŒ…æ‹¬ç½‘ç»œè®¾å¤‡ã€IP åœ°å€ã€IP è·¯ç”±è¡¨ã€ï¼procï¼net ç›®å½•ã€ç«¯å£å·ç­‰ç­‰ã€‚</p>
<p>å¯¹å®¹å™¨æ¥è¯´ï¼Œæ¯ä¸ªå®¹å™¨å°±å¯ä»¥æœ‰è‡ªå·±çš„ç½‘ç»œè®¾å¤‡ï¼Œcontainerized app ä¹Ÿå¯ä»¥ç»‘å®šåˆ°è‡ªå·±çš„ç«¯å£ç©ºé—´ã€‚Host æœºå™¨ä¸Šçš„è·¯ç”±è§„åˆ™ä¹Ÿå¯ä»¥æŠŠæ•°æ®åŒ…ä¼ é€ç»™æŒ‡å®šçš„å®¹å™¨ï¼ˆå…³è”åˆ°æŸä¸ªç½‘ç»œè®¾å¤‡ï¼‰ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">net</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">list</span><span class="p">;</span>		<span class="cm">/* list of network namespaces */</span>
	<span class="k">struct</span> <span class="n">user_namespace</span>   <span class="o">*</span><span class="n">user_ns</span><span class="p">;</span>	<span class="cm">/* Owning user namespace */</span>

	<span class="k">struct</span> <span class="n">netns_core</span>	<span class="n">core</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netns_mib</span>	<span class="n">mib</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netns_packet</span>	<span class="n">packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netns_unix</span>	<span class="n">unx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netns_nexthop</span>	<span class="n">nexthop</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netns_ipv4</span>	<span class="n">ipv4</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><code>net</code> ç»“æ„ä¸­åŒ…æ‹¬ï¼š</p>
<ul>
<li>å„ç§ net_xxx çš„ç½‘ç»œè®¾å¤‡</li>
<li>æ‰€å±çš„ user namespace</li>
<li>Network namespace çš„åˆ—è¡¨</li>
</ul>
<h2 id="uts-namespace">UTS Namespace</h2>
<p>UTS éš”ç¦» <code>nodename</code> å’Œ <code>domainname</code> ç³»ç»Ÿæ ‡è¯†ç¬¦ã€‚é€šè¿‡ uname è°ƒç”¨å¯ä»¥çœ‹åˆ°è¿™ä¸¤ä¸ªæ ‡è¯†ç¬¦çš„å€¼ã€‚å€ŸåŠ© UTS namespaceï¼Œå®¹å™¨å¯ä»¥æœ‰è‡ªå·±çš„ hostname å’Œ NIS domain nameã€‚UTS æ˜¯ &ldquo;UNIX Time-sharing System&rdquo; çš„ç¼©å†™ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">uts_namespace</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">kref</span> <span class="n">kref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">new_utsname</span> <span class="n">name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">user_namespace</span> <span class="o">*</span><span class="n">user_ns</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ucounts</span> <span class="o">*</span><span class="n">ucounts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ns_common</span> <span class="n">ns</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__randomize_layout</span><span class="p">;</span>
</code></pre></td></tr></table>
</div>
</div><p><code>uts_namespace</code> ç»“æ„ä½“ä¹Ÿæ˜¯æœ€ç®€å•çš„ï¼Œåªæœ‰æ‰€å±çš„ user namespaceã€‚</p>
<h2 id="ipc-namespace">IPC Namespace</h2>
<p>IPC namespace éš”ç¦»äº† System V IPC å’Œ POSIX æ¶ˆæ¯é˜Ÿåˆ—ã€‚è¿™ä¸¤ä¸ªéƒ½æ˜¯è¿›ç¨‹é€šä¿¡çš„èµ„æºã€‚åªæœ‰åœ¨ä¸€ä¸ª IPC namespace ä¸‹çš„è¿›ç¨‹æ‰èƒ½å¤Ÿé€šä¿¡ã€‚æ‰€ä»¥åœ¨åŒä¸€ä¸ª IPC namespace ä¸‹çš„è¿›ç¨‹å½¼æ­¤å¯è§ï¼Œè€Œä¸å…¶ä»–çš„ IPC namespace ä¸‹çš„è¿›ç¨‹åˆ™äº’ç›¸ä¸å¯è§ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">ipc_namespace</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">msg_ctlmax</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">msg_ctlmnb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">msg_ctlmni</span><span class="p">;</span>
	<span class="n">atomic_t</span>	<span class="n">msg_bytes</span><span class="p">;</span>
	<span class="n">atomic_t</span>	<span class="n">msg_hdrs</span><span class="p">;</span>

	<span class="n">size_t</span>		<span class="n">shm_ctlmax</span><span class="p">;</span>
	<span class="n">size_t</span>		<span class="n">shm_ctlall</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>    <span class="n">mq_queues_count</span><span class="p">;</span>

	<span class="cm">/* next fields are set through sysctl */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>    <span class="n">mq_queues_max</span><span class="p">;</span>   <span class="cm">/* initialized to DFLT_QUEUESMAX */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>    <span class="n">mq_msg_max</span><span class="p">;</span>      <span class="cm">/* initialized to DFLT_MSGMAX */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>    <span class="n">mq_msgsize_max</span><span class="p">;</span>  <span class="cm">/* initialized to DFLT_MSGSIZEMAX */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>    <span class="n">mq_msg_default</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>    <span class="n">mq_msgsize_default</span><span class="p">;</span>

	<span class="cm">/* user_ns which owns the ipc ns */</span>
	<span class="k">struct</span> <span class="n">user_namespace</span> <span class="o">*</span><span class="n">user_ns</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>Reference</strong></p>
<ul>
<li><a href="https://cizixs.com/2017/08/29/linux-namespace/">docker å®¹å™¨åŸºç¡€æŠ€æœ¯ï¼šlinux namespace ç®€ä»‹</a></li>
<li><a href="https://www.infoq.cn/article/docker-kernel-knowledge-namespace-resource-isolation">Docker èƒŒåçš„å†…æ ¸çŸ¥è¯†â€”â€”Namespace èµ„æºéš”ç¦»</a></li>
<li><a href="https://lwn.net/Articles/531114/">Namespaces in operation</a></li>
</ul>
    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        
        <a class="next" href="/zh/post/this-is-professionalism/">
            <span class="next-text nav-default">è¿™ä¸ªå°±å«ä¸“ä¸š ğŸš¬</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'guoqing';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="https://hellokangning.github.io/zh/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2016 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Guoqing Geng</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-105833321-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>

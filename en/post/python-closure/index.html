<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Python Closure - Guoqing Geng</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Guoqing Geng" />
  <meta name="description" content="A closure is a function with an extended scope that encompasses non-global variables but not defined there. It does not matter whether the function is anonymous of not, what matters is that it can access non-global variables that are defined outside of its body.
" />
<meta name="keywords" content="Python, Closure" />







<meta name="generator" content="Hugo 0.52" />


<link rel="canonical" href="https://hellokangning.github.io/en/post/python-closure/" />

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">







<link href="/dist/even.min.css?v=3.2.0" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">




<meta property="og:title" content="Python Closure" />
<meta property="og:description" content="A closure is a function with an extended scope that encompasses non-global variables but not defined there. It does not matter whether the function is anonymous of not, what matters is that it can access non-global variables that are defined outside of its body." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hellokangning.github.io/en/post/python-closure/" /><meta property="article:published_time" content="2018-09-19T18:38:29&#43;08:00"/>
<meta property="article:modified_time" content="2018-10-29T18:38:29&#43;08:00"/>

<meta itemprop="name" content="Python Closure">
<meta itemprop="description" content="A closure is a function with an extended scope that encompasses non-global variables but not defined there. It does not matter whether the function is anonymous of not, what matters is that it can access non-global variables that are defined outside of its body.">


<meta itemprop="datePublished" content="2018-09-19T18:38:29&#43;08:00" />
<meta itemprop="dateModified" content="2018-10-29T18:38:29&#43;08:00" />
<meta itemprop="wordCount" content="535">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Python Closure"/>
<meta name="twitter:description" content="A closure is a function with an extended scope that encompasses non-global variables but not defined there. It does not matter whether the function is anonymous of not, what matters is that it can access non-global variables that are defined outside of its body."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/en/" class="logo">Guoqing Geng</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/en/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/en/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/en/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/en/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/zh/">
        <li class="mobile-menu-item">中文</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/en/" class="logo">Guoqing Geng</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/en/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/en/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/en/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/en/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/zh/">中文</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Python Closure</h1>

      <div class="post-meta">
        <span class="post-time"> Sep 19, 2018 </span>
        <div class="post-category">
            
              <a href="/en/categories/python/"> Python </a>
            
          </div>
        <span class="more-meta"> 535 words </span>
        <span class="more-meta"> 3 mins read </span>
        
      </div>
    </header>

    
    
<div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li><a href="#nonlocal-declaration"><code>nonlocal</code> declaration</a></li>
</ul>
</nav>
  </div>
</div>

    
    

    
    <div class="post-content">
      <p>A closure is a function with an extended scope that encompasses non-global variables but not defined there. It does not matter whether the function is anonymous of not, what matters is that it can access non-global variables that are defined outside of its body.</p>

<p>This is a challenging concept to grasp, and is better approached through an example. Consider a <code>avg</code> function to compute the mean of an ever-increasing series of values. This is how <code>avg</code> could be used.</p>

<pre><code>&gt;&gt;&gt; avg(10)
10.0
&gt;&gt;&gt; avg(11)
10.5
&gt;&gt; avg(12)
11.0
</code></pre>

<p>A common way to do this is implementing a class <code>Averager</code>.</p>

<pre><code class="language-python">class Averager:
    def __init__(self):
        self.sum = 0.0
        self.count = 0

    def __call__(self, v):
        self.sum += v
        self.count += 1
        return self.sum / self.count

avg = Averager()
print(avg(10), avg(11), avg(12))
</code></pre>

<p>A functional implementation using a higher order function is:</p>

<pre><code class="language-python">def makeAverager():
    series = []

    def averager(v):
        series.append(v)
        return sum(series) / len(series)

    return averager

avg = makeAverager()
print(avg(10), avg(11), avg(12))
</code></pre>

<p>The <code>series</code> is a local variable of <code>makeAverager</code> because the initialization <code>series = []</code> happen in the body of that function. When <code>avg(10)</code> is called, <code>makeAverager</code> has already returned, its local scope is a long gone.</p>

<p>The closure for <code>averager</code> extends the scope of that function to include the binding for the free variable <code>series</code>.</p>

<p>Inspecting the returned <code>averager</code> object shows how Python keeps the names of local and free variables in the <code>__code__</code> attribute that represents the complied body of the function:</p>

<pre><code>&gt;&gt;&gt; avg.__code__.co_varnames
('v',)
&gt;&gt;&gt; print(avg.__code__.co_freevars)
('series',)
</code></pre>

<p>The binding for <code>series</code> is kept in the <code>__closure__</code> attribute of the returned function <code>avg</code>. Each item is <code>avg.__closure__</code> corresponds to a name in <code>avg.__code__co_freevars</code>. These items are cells with an attribute <code>cell_contents</code> where the actual value can be found.</p>

<pre><code>&gt;&gt;&gt; avg.__closure_
(&lt;cell at 0x10f5e9918: list object at 0x10f8178c8&gt;,)
&gt;&gt;&gt; avg.__closure__[0].cell_contents)
[10, 11, 12]
</code></pre>

<p>To summarize: a closure is a function that retains the bindings of the free variables that exist when the function is defined, so that they can be used later when the function is invoked and the defining scope is no long available.</p>

<h1 id="nonlocal-declaration"><code>nonlocal</code> declaration</h1>

<p>It is not necessary to keep the historical values. A better solution is to store the total and the number of items so far.</p>

<pre><code class="language-python">def makeAverager():
    total = count = 0

    def averager(v):
        total += v
        count += 1
        return total / count

    return averager

avg = makeAverager()
print(avg(10), avg(11), avg(12))
</code></pre>

<p>Oh, <code>UnboundLocalError</code>! The problem is that the statement <code>total += v</code> means the same as <code>total = total + v</code> assigning to <code>total</code> in the body with <code>averager</code> which makes it local.</p>

<p>With immutable types like numbers, strings, tuple etc., all you can is read, but never update. If you try to rebind them, as in <code>total += v</code>, <code>total</code> is no longer a free variable, there it&rsquo;s not saved in the closure.</p>

<p><code>nonlocal</code> declaration lets you flag a variable as a free variable even when it is assigned with the function.</p>

<pre><code class="language-python">def makeAverager():
    total = count = 0

    def averager(v):
        nonlocal total, count
        total += v
        count += 1
        return total / count

    return averager

avg = makeAverager()
print(avg(10), avg(11), avg(12))
</code></pre>

<p>Let us check he values in <code>__closure__</code>.</p>

<pre><code class="language-python">for item in avg.__closure__:
    print(item.cell_contents) # 3 33
</code></pre>

<p><strong>Reference</strong></p>

<p><a href="https://book.douban.com/subject/26278021/">Fluent Python</a></p>
    </div>

    
    

    
    

    <footer class="post-footer">
      

      
      <nav class="post-nav">
        
          <a class="prev" href="/en/post/managing-ordered-sequences-with-bisect/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Managing Ordered Sequences With bisect</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        
          <a class="next" href="/en/post/a-few-things-about-spark/">
            <span class="next-text nav-default">A Few Things That I Know About Spark</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        
  <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'guoqing';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:hellokangning@hotmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://www.linkedin.com/in/guoqing-geng-9032b820/" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="https://github.com/hellokangning" class="iconfont icon-github" title="github"></a>
      <a href="https://www.douban.com/people/hellokangning/" class="iconfont icon-douban" title="douban"></a>
      <a href="https://www.instagram.com/hellokangning/" class="iconfont icon-instagram" title="instagram"></a>
  <a href="https://hellokangning.github.io/en/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    
      2016 - 
    2018
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Guoqing Geng</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
<script src="/lib/highlight/highlight.pack.js?v=20171001"></script><script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>


<script type="text/javascript" src="/dist/even.min.js?v=3.2.0"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-105833321-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Java NIO: Selector - Qing&#39;s Landing</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Guoqing Geng" /><meta name="description" content="Taking FileChannel for example in the previous post may bewilder audiences: it&amp;rsquo;s non-blocking, so how does NIO achievement non-blocking? Here comes Selector.
A Selector is a Java NIO component which can examine one or more NIO Channel&amp;rsquo;s, and determine which channels are ready for reading or writing. A thread can manage multiply channels with Selector making multiple network connections feasible. This way avoids the cost of switching between threads which is expensive.
Here is an illustration of a thread using a Selector to handle 3 Channels:
" /><meta name="keywords" content="Java, NIO, Selector" />






<meta name="generator" content="Hugo 0.73.0 with theme even" />


<link rel="canonical" href="https://hellokangning.github.io/post/java-nio-selector/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.8c3cbcb0324c2bb4875ceccba4007cbad4b4ac8377f33af9953c3e7684534a50.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="Java NIO: Selector" />
<meta property="og:description" content="Taking FileChannel for example in the previous post may bewilder audiences: it&rsquo;s non-blocking, so how does NIO achievement non-blocking? Here comes Selector.
A Selector is a Java NIO component which can examine one or more NIO Channel&rsquo;s, and determine which channels are ready for reading or writing. A thread can manage multiply channels with Selector making multiple network connections feasible. This way avoids the cost of switching between threads which is expensive.
Here is an illustration of a thread using a Selector to handle 3 Channels:
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://hellokangning.github.io/post/java-nio-selector/" />
<meta property="article:published_time" content="2018-07-21T17:54:50+08:00" />
<meta property="article:modified_time" content="2018-07-21T17:54:50+08:00" />
<meta itemprop="name" content="Java NIO: Selector">
<meta itemprop="description" content="Taking FileChannel for example in the previous post may bewilder audiences: it&rsquo;s non-blocking, so how does NIO achievement non-blocking? Here comes Selector.
A Selector is a Java NIO component which can examine one or more NIO Channel&rsquo;s, and determine which channels are ready for reading or writing. A thread can manage multiply channels with Selector making multiple network connections feasible. This way avoids the cost of switching between threads which is expensive.
Here is an illustration of a thread using a Selector to handle 3 Channels:
">
<meta itemprop="datePublished" content="2018-07-21T17:54:50&#43;08:00" />
<meta itemprop="dateModified" content="2018-07-21T17:54:50&#43;08:00" />
<meta itemprop="wordCount" content="2095">



<meta itemprop="keywords" content="java.nio," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Java NIO: Selector"/>
<meta name="twitter:description" content="Taking FileChannel for example in the previous post may bewilder audiences: it&rsquo;s non-blocking, so how does NIO achievement non-blocking? Here comes Selector.
A Selector is a Java NIO component which can examine one or more NIO Channel&rsquo;s, and determine which channels are ready for reading or writing. A thread can manage multiply channels with Selector making multiple network connections feasible. This way avoids the cost of switching between threads which is expensive.
Here is an illustration of a thread using a Selector to handle 3 Channels:
"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Qing&#39;s Landing</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/en/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/zh/">
        <li class="mobile-menu-item">中文</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Qing&#39;s Landing</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/en/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/zh/">中文</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Java NIO: Selector</h1>

      <div class="post-meta">
        <span class="post-time"> Jul 21, 2018 </span>
        <div class="post-category">
            <a href="/categories/java/"> Java </a>
            </div>
          <span class="more-meta"> 2095 words </span>
          <span class="more-meta"> 5 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#creating-a-selector">Creating a Selector</a></li>
    <li><a href="#registering-channels-with-the-selector">Registering Channels with the Selector</a></li>
    <li><a href="#selectionkey">SelectionKey</a>
      <ul>
        <li><a href="#interest-set">Interest Set</a></li>
        <li><a href="#ready-set">Ready Set</a></li>
        <li><a href="#channel--selector">Channel + Selector</a></li>
        <li><a href="#attaching-objects">Attaching Objects</a></li>
      </ul>
    </li>
    <li><a href="#selecting-channels-via-a-selector">Selecting Channels via a Selector</a>
      <ul>
        <li><a href="#selectedkeys"><code>selectedKeys()</code></a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>Taking FileChannel for example in the <a href="https://hellokangning.github.io/post/java-nio-channel/">previous post</a> may bewilder audiences: it&rsquo;s non-blocking, so how does NIO achievement non-blocking? Here comes Selector.</p>
<p>A Selector is a Java NIO component which can examine one or more NIO Channel&rsquo;s, and determine which channels are ready for reading or writing. A thread can manage multiply channels with Selector making multiple network connections feasible. This way avoids the cost of switching between threads which is expensive.</p>
<p>Here is an illustration of a thread using a Selector to handle 3 Channels:</p>
<p><img src="/images/java-nio-selector-handle-channels.png" alt=""></p>
<h1 id="creating-a-selector">Creating a Selector</h1>
<p>You create a Selector by calling the Selector.open() method, like this: <code>Selector selector = Selector.open();</code>.</p>
<p>Loot at the multilevel inheritance hierarchy.</p>
<p><img src="/images/java-nio-selector-class.png" alt=""></p>
<p>Selector, even an abstract class, implements <code>open()</code> method to open a selector. The new selector is created by invoking <code>SelectorProvider#openSelector</code> method.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">// Selector.java

public abstract class Selector implements Closeable {
    public static Selector open() throws IOException {
        return SelectorProvider.provider().openSelector();
    }
}
</code></pre></td></tr></table>
</div>
</div><p>Regarding to <code>SelectorProvider#openSelector</code>, is also abstract, but instantiates a system-default provider class.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// SelectorProvider.java
</span><span class="c1"></span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">SelectorProvider</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">SelectorProvider</span> <span class="n">provider</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">AbstractSelector</span> <span class="nf">openSelector</span><span class="o">()</span>
        <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">SelectorProvider</span> <span class="nf">provider</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">lock</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">provider</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">return</span> <span class="n">provider</span><span class="o">;</span>
            <span class="k">return</span> <span class="n">AccessController</span><span class="o">.</span><span class="na">doPrivileged</span><span class="o">(</span>
                <span class="k">new</span> <span class="n">PrivilegedAction</span><span class="o">&lt;</span><span class="n">SelectorProvider</span><span class="o">&gt;()</span> <span class="o">{</span>
                    <span class="kd">public</span> <span class="n">SelectorProvider</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">loadProviderFromProperty</span><span class="o">())</span>
                                <span class="k">return</span> <span class="n">provider</span><span class="o">;</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">loadProviderAsService</span><span class="o">())</span>
                                <span class="k">return</span> <span class="n">provider</span><span class="o">;</span>
                            <span class="n">provider</span> <span class="o">=</span> <span class="n">sun</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">ch</span><span class="o">.</span><span class="na">DefaultSelectorProvider</span><span class="o">.</span><span class="na">create</span><span class="o">();</span>
                            <span class="k">return</span> <span class="n">provider</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>For Linux, it&rsquo;s EpollSelectorProvider.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// DefaultSelectorProvider.java
</span><span class="c1"></span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DefaultSelectorProvider</span> <span class="o">{</span>

    <span class="cm">/**
</span><span class="cm">     * Prevent instantiation.
</span><span class="cm">     */</span>
    <span class="kd">private</span> <span class="nf">DefaultSelectorProvider</span><span class="o">()</span> <span class="o">{</span> <span class="o">}</span>

    <span class="cm">/**
</span><span class="cm">     * Returns the default SelectorProvider.
</span><span class="cm">     */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">SelectorProvider</span> <span class="nf">create</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">EPollSelectorProvider</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="registering-channels-with-the-selector">Registering Channels with the Selector</h1>
<p>Before you use a Channel with a Selector, you must register the Channel with the Selector. Calling <code>SelectableChannel.register()</code> method can attain that.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">channel</span><span class="o">.</span><span class="na">configureBlocking</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
<span class="n">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">selector</span><span class="o">,</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>Only SelectableChannel can register with Selector, and the children of SelectableChannel must implement <code>configureBlocking</code>, which excludes FileChannel.</p>
<p>AbstractSelectableChannel, the child of SelectableChannel implements <code>register()</code> method by the following steps:</p>
<ul>
<li>get the lock</li>
<li>check if this channel is open</li>
<li>check whether or not the events you want to listen for is valid</li>
<li>check if this channel is in blocking mode</li>
<li>check if thew keys have been created</li>
<li>call <code>AbstractSelector#register</code> method</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// AbstractSelectableChannel.java
</span><span class="c1"></span>
<span class="kd">public</span> <span class="kd">final</span> <span class="n">SelectionKey</span> <span class="nf">register</span><span class="o">(</span><span class="n">Selector</span> <span class="n">sel</span><span class="o">,</span> <span class="kt">int</span> <span class="n">ops</span><span class="o">,</span>
                                   <span class="n">Object</span> <span class="n">att</span><span class="o">)</span>
    <span class="kd">throws</span> <span class="n">ClosedChannelException</span>
<span class="o">{</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">regLock</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">isOpen</span><span class="o">())</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ClosedChannelException</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">ops</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">validOps</span><span class="o">())</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">blocking</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalBlockingModeException</span><span class="o">();</span>
        <span class="n">SelectionKey</span> <span class="n">k</span> <span class="o">=</span> <span class="n">findKey</span><span class="o">(</span><span class="n">sel</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">k</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="n">ops</span><span class="o">);</span>
            <span class="n">k</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="n">att</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// New registration
</span><span class="c1"></span>            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">keyLock</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">isOpen</span><span class="o">())</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="n">ClosedChannelException</span><span class="o">();</span>
                <span class="n">k</span> <span class="o">=</span> <span class="o">((</span><span class="n">AbstractSelector</span><span class="o">)</span><span class="n">sel</span><span class="o">).</span><span class="na">register</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">ops</span><span class="o">,</span> <span class="n">att</span><span class="o">);</span>
                <span class="n">addKey</span><span class="o">(</span><span class="n">k</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">k</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>As to <code>AbstractSelector#register</code>, SelectorImpl derived from AbstractSelector implements the <code>register</code> method but leaves central work to an abstract method <code>impleRegister</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// SelectorImpl.java
</span><span class="c1"></span>
<span class="kd">protected</span> <span class="kd">final</span> <span class="n">SelectionKey</span> <span class="nf">register</span><span class="o">(</span><span class="n">AbstractSelectableChannel</span> <span class="n">ch</span><span class="o">,</span>
                                      <span class="kt">int</span> <span class="n">ops</span><span class="o">,</span>
                                      <span class="n">Object</span> <span class="n">attachment</span><span class="o">)</span>
<span class="o">{</span>
    <span class="k">if</span> <span class="o">(!(</span><span class="n">ch</span> <span class="k">instanceof</span> <span class="n">SelChImpl</span><span class="o">))</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalSelectorException</span><span class="o">();</span>
    <span class="n">SelectionKeyImpl</span> <span class="n">k</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SelectionKeyImpl</span><span class="o">((</span><span class="n">SelChImpl</span><span class="o">)</span><span class="n">ch</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
    <span class="n">k</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="n">attachment</span><span class="o">);</span>
    <span class="kd">synchronized</span> <span class="o">(</span><span class="n">publicKeys</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">implRegister</span><span class="o">(</span><span class="n">k</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">k</span><span class="o">.</span><span class="na">interestOps</span><span class="o">(</span><span class="n">ops</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">k</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">void</span> <span class="nf">implRegister</span><span class="o">(</span><span class="n">SelectionKeyImpl</span> <span class="n">ski</span><span class="o">);</span>
</code></pre></td></tr></table>
</div>
</div><p>EPollSelectorImpl, the offspring of SelectorImpl fills <code>impleRegister</code>. Few member variables involved include:</p>
<ul>
<li>closed: True if this Selector has been closed</li>
<li>fdToKey: Maps from file descriptors to keys</li>
<li>pollWrapper: The poll object</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// EPollSelectorImpl.java
</span><span class="c1"></span>
<span class="kd">class</span> <span class="nc">EPollSelectorImpl</span>
    <span class="kd">extends</span> <span class="n">SelectorImpl</span>
<span class="o">{</span>
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">boolean</span> <span class="n">closed</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span><span class="n">SelectionKeyImpl</span><span class="o">&gt;</span> <span class="n">fdToKey</span><span class="o">;</span>
    <span class="n">EPollArrayWrapper</span> <span class="n">pollWrapper</span><span class="o">;</span>


    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">implRegister</span><span class="o">(</span><span class="n">SelectionKeyImpl</span> <span class="n">ski</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">closed</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ClosedSelectorException</span><span class="o">();</span>
        <span class="n">SelChImpl</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">ski</span><span class="o">.</span><span class="na">channel</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">ch</span><span class="o">.</span><span class="na">getFDVal</span><span class="o">());</span>
        <span class="n">fdToKey</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span> <span class="n">ski</span><span class="o">);</span>
        <span class="n">pollWrapper</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">fd</span><span class="o">);</span>
        <span class="n">keys</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ski</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Notice the second parameter of the <code>register()</code> method. This is an &ldquo;interest set&rdquo;, meaning what events you are interested in listening for in the Channel, via the Selector. There are four different events you can listen for and represented by the four SelectionKey constants:</p>
<table>
<thead>
<tr>
<th>Event</th>
<th>SelecttionKey constant</th>
</tr>
</thead>
<tbody>
<tr>
<td>Connect</td>
<td>SelectionKey.OP_CONNECT</td>
</tr>
<tr>
<td>Accept</td>
<td>SelectionKey.OP_ACCEPT</td>
</tr>
<tr>
<td>Read</td>
<td>SelectionKey.OP_READ</td>
</tr>
<tr>
<td>Write</td>
<td>SelectionKey.OP_WRITE</td>
</tr>
</tbody>
</table>
<h1 id="selectionkey">SelectionKey</h1>
<p>When you register a channel with a <code>Selector</code> the <code>Channel.register()</code> method returns a <code>SelectionKey</code>object. This key represents that channels registration with that selector.</p>
<p>This <code>SelectionKey</code> object contains a few interesting properties:</p>
<ul>
<li>The interest set</li>
<li>The ready set</li>
<li>The Channel</li>
<li>The Selector</li>
<li>An attached object (optional)</li>
</ul>
<h2 id="interest-set">Interest Set</h2>
<p>The interest set determines which operation categories will be tested for readiness the next time one of the selector&rsquo;s selection methods is invoked.  The interest set is initialized with the value given when the key is created; it may later be changed via the <code>interestOps(int)</code> method or retrieves via the <code>interestOps()</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// SelectionKey.java
</span><span class="c1"></span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">SelectionKey</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">interestOps</span><span class="o">();</span>
  <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">SelectionKey</span> <span class="nf">interestOps</span><span class="o">(</span><span class="kt">int</span> <span class="n">ops</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>you can AND the interest set with the given <code>SelectionKey</code> constant to find out if a certain event is in the interest set.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kt">int</span> <span class="n">interestSet</span> <span class="o">=</span> <span class="n">selectionKey</span><span class="o">.</span><span class="na">interestOps</span><span class="o">();</span>

<span class="kt">boolean</span> <span class="n">isInterestedInAccept</span>  <span class="o">=</span> <span class="n">interestSet</span> <span class="o">&amp;</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_ACCEPT</span><span class="o">;</span>
<span class="kt">boolean</span> <span class="n">isInterestedInConnect</span> <span class="o">=</span> <span class="n">interestSet</span> <span class="o">&amp;</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_CONNECT</span><span class="o">;</span>
<span class="kt">boolean</span> <span class="n">isInterestedInRead</span>    <span class="o">=</span> <span class="n">interestSet</span> <span class="o">&amp;</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_READ</span><span class="o">;</span>
<span class="kt">boolean</span> <span class="n">isInterestedInWrite</span>   <span class="o">=</span> <span class="n">interestSet</span> <span class="o">&amp;</span> <span class="n">SelectionKey</span><span class="o">.</span><span class="na">OP_WRITE</span><span class="o">;</span>  
</code></pre></td></tr></table>
</div>
</div><p>The implementation of <code>interestOps</code> lies in SelectionKeyImpl.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// SelectionKeyImpl.java
</span><span class="c1"></span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SelectionKeyImpl</span>
    <span class="kd">extends</span> <span class="n">AbstractSelectionKey</span>
<span class="o">{</span>
	<span class="kd">final</span> <span class="n">SelChImpl</span> <span class="n">channel</span><span class="o">;</span> 
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">interestOps</span><span class="o">;</span>
    
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">ensureValid</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">isValid</span><span class="o">())</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">CancelledKeyException</span><span class="o">();</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">interestOps</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">ensureValid</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">interestOps</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">SelectionKey</span> <span class="nf">interestOps</span><span class="o">(</span><span class="kt">int</span> <span class="n">ops</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ensureValid</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">nioInterestOps</span><span class="o">(</span><span class="n">ops</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">SelectionKey</span> <span class="nf">nioInterestOps</span><span class="o">(</span><span class="kt">int</span> <span class="n">ops</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">ops</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">channel</span><span class="o">().</span><span class="na">validOps</span><span class="o">())</span> <span class="o">!=</span> <span class="n">0</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">();</span>
        <span class="n">channel</span><span class="o">.</span><span class="na">translateAndSetInterestOps</span><span class="o">(</span><span class="n">ops</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
        <span class="n">interestOps</span> <span class="o">=</span> <span class="n">ops</span><span class="o">;</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The child of Channel, SocketChannelImpl here, translates native poll recent ops into a ready operation ops with <code>SocketChannelImpl#translateAndSetInterestOps</code> method.</p>
<h2 id="ready-set">Ready Set</h2>
<p>The ready set identifies the operation categories for which the key&rsquo;s channel has been detected to be ready by the key&rsquo;s selector. The ready set is initialized to zero when the key is created; it may later be updated by the selector during a selection operation, but it cannot be updated directly.</p>
<p>The <code>readyOps()</code> method in SelectionKey opens the door to retrieve this key&rsquo;s ready-operation set.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// SelectionKey.java
</span><span class="c1"></span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">SelectionKey</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">readyOps</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>You can test in the same way as with the interest set, what events / operations the channel is ready for. But, you can also use these four methods instead, which all reaturn a boolean:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">selectionKey.isAcceptable();
selectionKey.isConnectable();
selectionKey.isReadable();
selectionKey.isWritable();
</code></pre></td></tr></table>
</div>
</div><h2 id="channel--selector">Channel + Selector</h2>
<p>Accessing the channel + selector from the <code>SelectionKey</code> is trivial. Here is how it&rsquo;s done:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">Channel  channel  = selectionKey.channel();
Selector selector = selectionKey.selector();  
</code></pre></td></tr></table>
</div>
</div><p>Remember the structure of SelectionKeyImpl? It has a package-private member named <code>channel</code> and  a public one <code>selector</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// SelectionKeyImpl.java
</span><span class="c1"></span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SelectionKeyImpl</span>
    <span class="kd">extends</span> <span class="n">AbstractSelectionKey</span>
<span class="o">{</span>
	<span class="kd">final</span> <span class="n">SelChImpl</span> <span class="n">channel</span><span class="o">;</span>                            <span class="c1">// package-private
</span><span class="c1"></span>	<span class="kd">public</span> <span class="kd">final</span> <span class="n">SelectorImpl</span> <span class="n">selector</span><span class="o">;</span>
	
	<span class="kd">public</span> <span class="n">SelectableChannel</span> <span class="nf">channel</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">SelectableChannel</span><span class="o">)</span><span class="n">channel</span><span class="o">;</span>
    <span class="o">}</span>
    
    <span class="kd">public</span> <span class="n">Selector</span> <span class="nf">selector</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">selector</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="attaching-objects">Attaching Objects</h2>
<p>You can attach an object to a SelectionKey providing a handy way of recognizing a given channel.</p>
<p>Here is how you attach objects:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">selectionKey</span><span class="o">.</span><span class="na">attach</span><span class="o">(</span><span class="n">theObject</span><span class="o">);</span>
<span class="n">Object</span> <span class="n">attachedObj</span> <span class="o">=</span> <span class="n">selectionKey</span><span class="o">.</span><span class="na">attachment</span><span class="o">();</span>
</code></pre></td></tr></table>
</div>
</div><p>AtomicReferenceFieldUpdater, a reflection-based utility, is engaged in to that enable atomic updates to designated volatile reference fields of designated classes.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// SelectionKey.java
</span><span class="c1"></span>    
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">SelectionKey</span> <span class="o">{</span>    
    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">Object</span> <span class="n">attachment</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">AtomicReferenceFieldUpdater</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">,</span><span class="n">Object</span><span class="o">&gt;</span>
        <span class="n">attachmentUpdater</span> <span class="o">=</span> <span class="n">AtomicReferenceFieldUpdater</span><span class="o">.</span><span class="na">newUpdater</span><span class="o">(</span>
            <span class="n">SelectionKey</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">Object</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&#34;attachment&#34;</span>
        <span class="o">);</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Object</span> <span class="nf">attach</span><span class="o">(</span><span class="n">Object</span> <span class="n">ob</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">attachmentUpdater</span><span class="o">.</span><span class="na">getAndSet</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">ob</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="n">Object</span> <span class="nf">attachment</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">attachment</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><h1 id="selecting-channels-via-a-selector">Selecting Channels via a Selector</h1>
<p>Once you have registered one or more channels with a Selector, you can call one of the <code>select()</code> methods.  These methods select a set of keys whose corresponding channels are ready for I/O operations(connect, accept, read or write).</p>
<p>Here are the select() methods:</p>
<ul>
<li><code>int select()</code> performs a blocking selection operation. It returns only after at least one channel is selected, this selector&rsquo;s <code>wakeup</code> method is invoked, or the current thread is interrupted, whichever comes first.</li>
<li><code>int select(long timeout)</code> does the same as <code>select()</code> except it blocks for a maximum of timeout milliseconds.</li>
<li><code>int selectNow()</code> performs a non-blocking selection operation.  If no channels have become selectable since the previous selection operation then this method immediately returns zero. Invoking this method clears the effect of any previous invocations of the <code>wakeup</code> method.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// SelectorImpl.java
</span><span class="c1"></span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">SelectorImpl</span>
    <span class="kd">extends</span> <span class="n">AbstractSelector</span>
<span class="o">{</span>
    <span class="kd">protected</span> <span class="kd">abstract</span> <span class="kt">int</span> <span class="nf">doSelect</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">select</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">)</span>
        <span class="kd">throws</span> <span class="n">IOException</span>
    <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="n">0</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&#34;Negative timeout&#34;</span><span class="o">);</span>
        <span class="k">return</span> <span class="n">lockAndDoSelect</span><span class="o">((</span><span class="n">timeout</span> <span class="o">==</span> <span class="n">0</span><span class="o">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">1</span> <span class="o">:</span> <span class="n">timeout</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">select</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">select</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">selectNow</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">lockAndDoSelect</span><span class="o">(</span><span class="n">0</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">lockAndDoSelect</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">isOpen</span><span class="o">())</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">ClosedSelectorException</span><span class="o">();</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">publicKeys</span><span class="o">)</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">publicSelectedKeys</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">return</span> <span class="n">doSelect</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>SelectorImpl leaves <code>doSelect(long)</code> unimplemented to its derived class. Let&rsquo;s see what EPollSelectorImpl does.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// EPollSelectorImpl.java
</span><span class="c1"></span>
<span class="kd">class</span> <span class="nc">EPollSelectorImpl</span>
    <span class="kd">extends</span> <span class="n">SelectorImpl</span>
<span class="o">{</span>
    <span class="kd">protected</span> <span class="kt">int</span> <span class="nf">doSelect</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">closed</span><span class="o">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ClosedSelectorException</span><span class="o">();</span>
        <span class="n">processDeregisterQueue</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">begin</span><span class="o">();</span>
            <span class="n">pollWrapper</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">end</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="n">processDeregisterQueue</span><span class="o">();</span>
        <span class="kt">int</span> <span class="n">numKeysUpdated</span> <span class="o">=</span> <span class="n">updateSelectedKeys</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">pollWrapper</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// Clear the wakeup pipe
</span><span class="c1"></span>            <span class="n">pollWrapper</span><span class="o">.</span><span class="na">putEventOps</span><span class="o">(</span><span class="n">pollWrapper</span><span class="o">.</span><span class="na">interruptedIndex</span><span class="o">(),</span> <span class="n">0</span><span class="o">);</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">interruptLock</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">pollWrapper</span><span class="o">.</span><span class="na">clearInterrupted</span><span class="o">();</span>
                <span class="n">IOUtil</span><span class="o">.</span><span class="na">drain</span><span class="o">(</span><span class="n">fd0</span><span class="o">);</span>
                <span class="n">interruptTriggered</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">numKeysUpdated</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>EPollSelectorImpl appeals to EPollArrayWrapper who manipulates a native array of <code>epoll_event</code> structs on Linux. The int returned by the <code>select()</code> methods tells how many channels are ready.</p>
<h2 id="selectedkeys"><code>selectedKeys()</code></h2>
<p>Once you have called one of the <code>select()</code> methods and its return value has indicated that one or more channels are ready, you can access the ready channels via the &ldquo;selected key set&rdquo;, by calling the selectors selectedKeys() method. Here is how that looks:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Set</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="n">selectedKeys</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">();</span>  
</code></pre></td></tr></table>
</div>
</div><p>The implementation of <code>selectedKeys()</code> is in SelectorImpl using a Set named <code>publicSelectedKeys</code> to store keys that are going to be selected.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="c1">// SelectorImpl.java
</span><span class="c1"></span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">SelectorImpl</span>
    <span class="kd">extends</span> <span class="n">AbstractSelector</span>
<span class="o">{</span>
    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="n">publicKeys</span><span class="o">;</span>             <span class="c1">// Immutable
</span><span class="c1"></span>    <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="n">publicSelectedKeys</span><span class="o">;</span>     <span class="c1">// Removal allowed, but not addition
</span><span class="c1"></span>
    <span class="kd">public</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="nf">selectedKeys</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!</span><span class="n">isOpen</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Util</span><span class="o">.</span><span class="na">atBugLevel</span><span class="o">(</span><span class="s">&#34;1.4&#34;</span><span class="o">))</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">ClosedSelectorException</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">publicSelectedKeys</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>When you register a channel with a Selector the <code>Channel.register()</code> method returns a SelectionKey object. This key represents that channels registration with that selector. It is these keys you can access via the <code>selectedKeySet() </code>method from the SelectionKey.</p>
<p>You can iterate this selected key set to access the ready channels. Here is how that looks:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Set</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="n">selectedKeys</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="na">selectedKeys</span><span class="o">();</span>

<span class="n">Iterator</span><span class="o">&lt;</span><span class="n">SelectionKey</span><span class="o">&gt;</span> <span class="n">keyIterator</span> <span class="o">=</span> <span class="n">selectedKeys</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>

<span class="k">while</span><span class="o">(</span><span class="n">keyIterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
    
    <span class="n">SelectionKey</span> <span class="n">key</span> <span class="o">=</span> <span class="n">keyIterator</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>

    <span class="k">if</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isAcceptable</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// a connection was accepted by a ServerSocketChannel.
</span><span class="c1"></span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isConnectable</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// a connection was established with a remote server.
</span><span class="c1"></span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isReadable</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// a channel is ready for reading
</span><span class="c1"></span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">isWritable</span><span class="o">())</span> <span class="o">{</span>
        <span class="c1">// a channel is ready for writing
</span><span class="c1"></span>    <span class="o">}</span>

    <span class="n">keyIterator</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Notice the <code>keyIterator.remove()</code> call at the end of each iteration. The Selector does not remove the SelectionKey instances from the selected key set itself. You have to do this, when you are done processing the channel. The next time the channel becomes &ldquo;ready&rdquo; the Selector will add it to the selected key set again.</p>
<p><strong>Reference</strong></p>
<ul>
<li><a href="http://tutorials.jenkov.com/java-nio/index.html">Java NIO Tutorial</a></li>
<li><a href="https://www.javacodegeeks.com/2018/07/java-nio-tutorial.html">Java NIO Tutorial</a></li>
<li><a href="https://juejin.im/post/5af942c6f265da0b7026050c">nio你了解多少？</a></li>
</ul>
    </div>

    
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/java.nio/">java.nio</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/binary-search-for-upper-bound/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Binary Search for Upper Bound</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/java-nio-channel/">
            <span class="next-text nav-default">Java NIO: Channel</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'gugeng';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:hellokangning@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://www.linkedin.com/in/guoqing-geng-9032b820/" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="https://github.com/hellokangning" class="iconfont icon-github" title="github"></a>
      <a href="https://www.douban.com/people/hellokangning/" class="iconfont icon-douban" title="douban"></a>
      <a href="https://www.instagram.com/hellokangning/" class="iconfont icon-instagram" title="instagram"></a>
  <a href="https://hellokangning.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2016 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Guoqing Geng</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>



<script type="text/javascript" src="/js/main.min.d7b7ada643c9c1a983026e177f141f7363b4640d619caf01d8831a6718cd44ea.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-105833321-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
